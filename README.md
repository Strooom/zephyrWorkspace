# Zephyr Workspace Template


This repo contans the files typically needed in a West Workspace for a Zephyr Project.
```
workspaceFolder/
├── .claude/
│   └── agents/
├── .vscode/
├── .west/
│   └── config
├── .gitattributes
├── .gitignore
├── CLAUDE.md
├── README.md
└── zephyrWorkspace.code-workspace
```

## Prerequisites
* I assume you are on Linux Ubuntu or on Windows WSL Ubuntu. I tried to make this work for Windows, but once you touch more advanced things, Windows is no longer supported.
* So set up a Linux or WSL and follow the first two steps of Zephyr's Getting Started Guide :
  * Install dependencies : this is installing a number of Linux tools (Python, CMake, DTC and others) needed by Zephyr. Let those tools install in their preferred locations.
  * I created a folder `~/projects/zephyr` which will hold all my Zephyr development projects.
  * Set up a `Virtual Environment` for Python. Zephyr is using a lot of Python and requires a very specific setup for Python. It's more robust to have all this together in a separate folder, and that is what a virtual environment does. I have created my `venv` in `~/projects/zephyr/venv`, so it stays close to my projects.
  * Whenever you are using a terminal, it needs to have that virtual environment **activated**. To make this easier, I created an alias in my .bashrc : `alias activate='source ~/projects/zephyr/venv/bin/activate'`

## Template or Project
In the next steps you'll first create a `West Workspace` which in turn contains your `new zephyrProject`. 
```
West Workspace/
└── zephyrProject
```

Over time you will configure the zephyr project with specific stuff beyond the template. So you probably want to first create a new repository (eg myZephyrProject) from the template (zephyrProject), and use this in Step 2. 

Note : this template has `develop` as default branch

## Step 1 : Clone the repository into the location of your **West Workspace** for the new **Zephyr Project**
```shell
activate
mkdir <newZephyrProjectWorkspaceName>
git clone https://github.com/Strooom/zephyrWorkspace <newZephyrProjectWorkspaceName>
```

Once cloned, I usually open the VSCode workspace defined in this repository.

## Step 2 : Clone the repository for the **Zephyr Project**
From the new workspace folder...
```shell
git clone https://github.com/Strooom/<zephyrProjectName> -b develop app
```

## Step 3 : Initialise West
```shell
west init -l app
```

## Step 4 : West Update
This will take a while and download ~2.4 Gbyte in folders /zephyr and /modules

It will **not** go in the repository. It can always be deleted and regenerated later.
```shell
west update
```

## Step 5 : Update the virtual Python environment with extra tools needed by Zephyr
Open a Terminal, in the workspace folder, activate the virtual environment.

Then run the following command for updating all tools
```shell
pip install --upgrade -r zephyr/scripts/requirements.txt
```

# Result
Now the repository should look like
```
workspaceFolder/
├── .claude/
│   └── agents/
├── .vscode/
├── .west/
│   └── config
├── app/                    ← zephyrProject repo (Step 2)
│   ├── boards/
│   ├── lib/
│   ├── src/
│   ├── tests/
│   ├── CMakeLists.txt
│   ├── prj.conf
│   └── west.yml
├── modules/                ← generated by west update (Step 4)
├── zephyr/                 ← generated by west update (Step 4)
├── .gitattributes
├── .gitignore
├── CLAUDE.md
├── README.md
└── zephyrWorkspace.code-workspace
```

## SDKs
One more thing Zephyr needs is the so-called SDK : it is basically the collection of cross-compiler, assembler, linker, etc. All these tools are specific for the MCU architecture you are targetting, eg STM32 (= ARM), ESP32 (= xtensa). 
If you don't care about diskspace, you can install them all, but I tend to install only the ones I am going to use. 
In order to keep my Zephyr development things together, I decided to install the SDK in `~/projects/zephyr/sdks`, that's not the default, so it requires the -b option on the command.
From the workspace directory, run
```shell
west sdk install -b ~/projects/zephyr/sdks -i
# -b <destinationParentDirectory>
# -i interactive : choose the toolchain sets you want
```
I chose `Install host tools` and `Register Zephyr SDK CMake package` but I don't understand yet what this does...


# Notes
* the `west.yml` in the zephyrProject repo has `revision: main`, which will install the latest version. You may want to fix this to a certain release.

## Testing
### Local build
Now is the time to try if we can build the minimal Hello World app in `src/main.c`. As we are on Linux, we can simply build for a board called `native_sim`, which will build a binary that runs on our host computer. This is possible because the application does not use any real hardware devices. From inside the **app** folder, run
```shell
west build -b native_sim
```
The build process will create a `build` folder. The resulting binary can be found in `build/zephyr/zephyr.exe`. 
You can run it :
```shell
build/zephyr/zephyr.exe
```
and it will output Hello World ! every second. Use CTRL+C to stop it.

### Cloud build
The zephyrProject (template) repository has a CI/CD workflow set up, so when you push commits, it will run the whole build process in a github action as well. To try it, make some (trivial) changes to src/main.c and commit them. Then take a look at github.com under the Actions to see if the workflow runs and succeeds.


